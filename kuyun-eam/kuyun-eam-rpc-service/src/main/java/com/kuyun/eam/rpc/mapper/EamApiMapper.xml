<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kuyun.eam.rpc.mapper.EamApiMapper">

	<resultMap id="EamMaintenanceVOResultMap" type="com.kuyun.eam.vo.EamMaintenanceVO" extends="com.kuyun.eam.dao.mapper.EamMaintenanceMapper.BaseResultMap">
		<result column="equipment_name" jdbcType="VARCHAR" property="equipmentName" />
		<result column="equipment_number" jdbcType="VARCHAR" property="equipmentNumber" />
		<result column="part_name" jdbcType="VARCHAR" property="partName" />
		<result column="maintain_user_name" jdbcType="VARCHAR" property="maintainUserName" />
	</resultMap>


	<!-- 维保字段 -->
	<sql id="Maintenance_Column_List">
		t.maintenance_id, t.equipment_id, t.part_id, t.part_quantity, t.reason, t.content, t.maintain_user_id, t.maintain_time,
		t.create_user_id, t.create_time, t.update_user_id, t.update_time, t.delete_flag,
	</sql>



	<select id="selectMaintenance" parameterType="com.kuyun.eam.vo.EamMaintenanceVO" resultMap="EamMaintenanceVOResultMap">
		select
		<include refid="Maintenance_Column_List" />
		e.name as equipment_name,
		e.number as equipment_number,
		p.name as part_name,
		u.realname as maintain_user_name
		from eam_maintenance t
		LEFT JOIN eam_equipment e ON t.equipment_id = e.equipment_id
		LEFT JOIN eam_parts p on  t.part_id = p.part_id
		LEFT JOIN upms_user u on t.maintain_user_id = u.user_id
		WHERE t.delete_flag = 0
		<if test="companyId != null and companyId != ''">
			AND t.company_id = #{companyId}
		</if>

		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>

	<resultMap id="EamLocationVOResultMap" type="com.kuyun.eam.vo.EamLocationVO" extends="com.kuyun.eam.dao.mapper.EamLocationMapper.BaseResultMap">
		<result column="warehouse_name" jdbcType="VARCHAR" property="warehouseName" />
	</resultMap>


	<!-- 仓位字段 -->
	<sql id="Location_Column_List">
		t.location_id, t.warehouse_id, t.number, t.comments,
		t.create_user_id, t.create_time, t.update_user_id, t.update_time, t.delete_flag,
		t.company_id,
	</sql>



	<select id="selectLocation" parameterType="com.kuyun.eam.vo.EamLocationVO" resultMap="EamLocationVOResultMap">
		select

		<include refid="Location_Column_List" />
		e.name as warehouse_name
		from eam_Location t
		LEFT JOIN eam_warehouse e ON t.warehouse_id = e.warehouse_id
		WHERE t.delete_flag = 0
		<if test="companyId != null and companyId != ''">
			AND t.company_id = #{companyId}
		</if>
		<if test="warehouseId != null">
			AND t.warehouse_id = #{warehouseId}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>


	<resultMap id="EamPartVOResultMap" type="com.kuyun.eam.vo.EamPartVO" extends="com.kuyun.eam.dao.mapper.EamPartsMapper.BaseResultMap">
		<result column="category_name" jdbcType="VARCHAR" property="categoryName" />
		<result column="equipment_name" jdbcType="VARCHAR" property="equipmentName" />
		<result column="product_line_name" jdbcType="VARCHAR" property="productLineName" />
	</resultMap>


	<!-- 配件字段 -->
	<sql id="Part_Column_List">
		t.part_id, t.equipment_id, t.product_line_id, t.category_id, t.seq_id, t.symbol, t.name, t.model, t.material, t.quantity,
    	t.create_user_id, t.create_time, t.update_user_id, t.update_time, t.delete_flag, t.company_id,
	</sql>



	<select id="selectParts" parameterType="com.kuyun.eam.vo.EamPartVO" resultMap="EamPartVOResultMap">
		select DISTINCT
		<include refid="Part_Column_List" />
		c.name as category_name,
		e.name as equipment_name,
		p.name as product_line_name
		from eam_parts t
		LEFT JOIN eam_parts_category c ON t.category_id = c.category_id
		LEFT JOIN eam_equipment e ON t.equipment_id = e.equipment_id
		LEFT JOIN eam_product_line p ON t.product_line_id = p.product_line_id
		LEFT JOIN eam_product_line_company  ec ON t.product_line_id = ec.product_line_id
		WHERE t.delete_flag = 0 and e.delete_flag = 0 and p.delete_flag = 0
		<if test="equipmentId != null and equipmentId != ''">
			AND e.equipment_id = #{equipmentId}
		</if>
		<if test="productLineId != null and productLineId != ''">
			AND e.product_line_id = #{productLineId}
		</if>
		<if test="taskNumber != null and taskNumber != ''">
			AND e.task_number = #{taskNumber}
		</if>
		<if test="serialNumber != null and serialNumber != ''">
			AND e.serial_number = #{serialNumber}
		</if>
		<if test="symbol != null and symbol != ''">
			AND t.symbol = #{symbol}
		</if>
		<if test="categoryId != null and categoryId != ''">
			AND t.category_id = #{categoryId}
		</if>
		<if test="model != null and model != ''">
			AND t.model = #{model}
		</if>
		<if test="companyId != null and companyId != ''">
			AND ec.company_id = #{companyId}
		</if>
		<if test="name != null and name != ''">
			<bind name="pattern" value="'%' + name + '%'" />
			AND t.name like #{pattern}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>

	<select id="countParts" parameterType="com.kuyun.eam.vo.EamPartVO" resultType="java.lang.Long">
		select count(DISTINCT t.part_id)
		from eam_parts t
		LEFT JOIN eam_parts_category c ON t.category_id = c.category_id
		LEFT JOIN eam_equipment e ON t.equipment_id = e.equipment_id
		LEFT JOIN eam_product_line p ON t.product_line_id = p.product_line_id
		LEFT JOIN eam_product_line_company  ec ON t.product_line_id = ec.product_line_id
		WHERE t.delete_flag = 0 and e.delete_flag = 0 and p.delete_flag = 0
		<if test="equipmentId != null and equipmentId != ''">
			AND e.equipment_id = #{equipmentId}
		</if>
		<if test="productLineId != null and productLineId != ''">
			AND e.product_line_id = #{productLineId}
		</if>
		<if test="taskNumber != null and taskNumber != ''">
			AND e.task_number = #{taskNumber}
		</if>
		<if test="serialNumber != null and serialNumber != ''">
			AND e.serial_number = #{serialNumber}
		</if>
		<if test="symbol != null and symbol != ''">
			AND t.symbol = #{symbol}
		</if>
		<if test="categoryId != null and categoryId != ''">
			AND t.category_id = #{categoryId}
		</if>
		<if test="model != null and model != ''">
			AND t.model = #{model}
		</if>
		<if test="companyId != null and companyId != ''">
			AND ec.company_id = #{companyId}
		</if>
		<if test="name != null and name != ''">
			<bind name="pattern" value="'%' + name + '%'" />
			AND t.name like #{pattern}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
	</select>


	<resultMap id="EamInventoryVOResultMap" type="com.kuyun.eam.vo.EamInventoryVO" extends="com.kuyun.eam.dao.mapper.EamInventoryMapper.BaseResultMap">
		<result column="warehouse_name" jdbcType="VARCHAR" property="warehouseName" />
		<result column="location_number" jdbcType="VARCHAR" property="locationNumber" />
		<result column="part_name" jdbcType="VARCHAR" property="partName" />
	</resultMap>


	<!-- 库存字段 -->
	<sql id="Inventory_Column_List">
		t.inventory_id, t.warehouse_id, t.location_id, t.part_id, t.quantity, t.in_task_date,
		t.create_user_id, t.create_time, t.update_user_id, t.update_time, t.delete_flag,
		t.company_id,
	</sql>



	<select id="selectInventory" parameterType="com.kuyun.eam.vo.EamInventoryVO" resultMap="EamInventoryVOResultMap">
		select

		<include refid="Inventory_Column_List" />
		w.name as warehouse_name,
		l.number as location_number,
		p.name as part_name
		from eam_inventory t
		LEFT JOIN eam_warehouse w ON t.warehouse_id = w.warehouse_id
		LEFT JOIN eam_location l ON t.location_id = l.location_id
		LEFT JOIN eam_parts p ON t.part_id = p.part_id
		WHERE t.delete_flag = 0
		<if test="companyId != null and companyId != ''">
			AND t.company_id = #{companyId}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>





	<resultMap id="EamTicketVOResultMap" type="com.kuyun.eam.vo.EamTicketVO" extends="com.kuyun.eam.dao.mapper.EamTicketMapper.BaseResultMap">
		<result column="serviceman" jdbcType="VARCHAR" property="serviceman" />
		<result column="servicePhone" jdbcType="VARCHAR" property="servicePhone" />
		<result column="customerContacts" jdbcType="VARCHAR" property="customerContacts" />
		<result column="customerPhone" jdbcType="VARCHAR" property="customerPhone" />
		<result column="assessmentDescription" jdbcType="VARCHAR" property="assessmentDescription" />
		<result column="productLineName" jdbcType="VARCHAR" property="productLineName" />
		<result column="equipmentName" jdbcType="VARCHAR" property="equipmentName" />
		<result column="assessmentLevel" jdbcType="INTEGER" property="assessmentLevel" />
		<result column="assessmentId" jdbcType="INTEGER" property="assessmentId" />
		<association property="ticketType" resultMap="com.kuyun.eam.dao.mapper.EamTicketTypeMapper.BaseResultMap"></association>
	</resultMap>

	<select id="selectTicket" parameterType="com.kuyun.eam.dao.model.EamTicketExample" resultMap="EamTicketVOResultMap">
		select
		<include refid="com.kuyun.eam.dao.mapper.EamTicketMapper.Base_Column_List" />,
		(select uu.realname from upms_user uu where eam_ticket.executor_id = uu.user_id) as serviceman,
		(select uu.phone from upms_user uu where eam_ticket.executor_id = uu.user_id) as servicePhone,
		(select cu.realname from upms_user cu where eam_ticket.create_user_id = cu.user_id)  as customerContacts,
		(select cu.phone from upms_user cu where eam_ticket.create_user_id = cu.user_id)  as customerPhone,
		(select ass.assessment_level from eam_ticket_assessment ass where eam_ticket.ticket_id = ass.ticket_id) as assessmentLevel,
		(select ass.description from eam_ticket_assessment ass where eam_ticket.ticket_id = ass.ticket_id) as assessmentDescription,
		p.name as productLineName,
		e.name as equipmentName,
		(select ass.id from eam_ticket_assessment ass where eam_ticket.ticket_id = ass.ticket_id) as assessmentId,
		<include refid="com.kuyun.eam.dao.mapper.EamTicketTypeMapper.Base_Column_List"/>
		from eam_ticket
		LEFT OUTER JOIN eam_ticket_type  ON eam_ticket.ticket_type_id = eam_ticket_type.id
		LEFT OUTER JOIN eam_product_line p ON eam_ticket.product_line_id = p.product_line_id
		LEFT OUTER JOIN eam_equipment e ON eam_ticket.equipment_id = e.equipment_id
		<if test="_parameter != null">
			<include refid="com.kuyun.eam.dao.mapper.EamTicketMapper.Example_Where_Clause" />
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>



	<select id="selectAlarmsByGrmVariable" parameterType="com.kuyun.eam.dao.model.EamGrmVariableData" resultMap="com.kuyun.eam.dao.mapper.EamAlarmMapper.BaseResultMap">
		select
		<include refid="com.kuyun.eam.dao.mapper.EamAlarmMapper.Base_Column_List" />
		from eam_alarm, eam_grm_variable_data s
		WHERE s.product_line_id = eam_alarm.product_line_id
		AND s.equipment_id = eam_alarm.equipment_id
		AND s.data_element_id = eam_alarm.eam_data_element_id
		AND eam_alarm.delete_flag = 0 AND s.delete_flag = 0
		<if test="equipmentId != null and equipmentId != ''">
			AND s.equipment_id = #{equipmentId}
		</if>
		<if test="productLineId != null and productLineId != ''">
			AND s.product_line_id = #{productLineId}
		</if>
		<if test="dataElementId != null and dataElementId != ''">
			AND s.data_element_id = #{dataElementId}
		</if>
	</select>


	<resultMap id="EamAlarmRecordVOResultMap" type="com.kuyun.eam.vo.EamAlarmRecordVO" extends="com.kuyun.eam.dao.mapper.EamAlarmRecordMapper.BaseResultMap">
		<result column="alarm_name" jdbcType="VARCHAR" property="alarmName" />
		<result column="alarm_value" jdbcType="VARCHAR" property="alarmValue" />
		<result column="alarm_clear_value" jdbcType="VARCHAR" property="alarmClearValue" />
		<result column="alarm_type" jdbcType="VARCHAR" property="alarmType" />
		<result column="upper_Bound" jdbcType="DECIMAL" property="upperBound" />
		<result column="lower_Bound" jdbcType="DECIMAL" property="lowerBound" />
		<result column="duration" jdbcType="DECIMAL" property="duration" />
		<result column="alarm_target" jdbcType="VARCHAR" property="alarmTarget" />
		<result column="user_name" jdbcType="VARCHAR" property="userName" />
		<result column="equipment_name" jdbcType="VARCHAR" property="equipmentName" />
		<result column="equipment_number" jdbcType="VARCHAR" property="equipmentNumber" />
		<result column="product_line_name" jdbcType="VARCHAR" property="productLineName" />
	</resultMap>

	<sql id="Alarm_Record_Column_List">
		t.id, t.alarm_id, t.equipment_id, t.product_line_id, t.alarm_value, t.alarm_status, t.create_user_id,
        t.create_time, t.update_user_id, t.update_time, t.delete_flag, t.company_id,
	</sql>

	<select id="selectAlarmRecords" parameterType="com.kuyun.eam.vo.EamAlarmRecordVO" resultMap="EamAlarmRecordVOResultMap">
		select DISTINCT
		<include refid="Alarm_Record_Column_List" />
		a.name as alarm_name,
		a.alarm_type,
		a.upper_Bound,
		a.lower_Bound,
		a.duration,
		a.alarm_target,
		group_concat(uu.realname) AS user_name,
		e.name as equipment_name,
		e.number as equipment_number,
		f.name as product_line_name
		from eam_alarm_record t
		LEFT JOIN eam_alarm a ON t.alarm_id = a.alarm_id
		LEFT JOIN eam_alarm_target_user u ON t.alarm_id = u.alarm_id AND u.delete_flag = 0
		LEFT JOIN upms_user uu ON uu.user_id = u.user_id
		LEFT JOIN eam_equipment e ON e.equipment_id = t.equipment_id
		LEFT JOIN eam_product_line f ON f.product_line_id = t.product_line_id
		WHERE t.delete_flag = 0 AND a.delete_flag = 0 AND f.delete_flag = 0
		AND e.delete_flag = 0

		<if test="productLineIds != null">
			AND t.product_line_id IN
			<foreach item="item" index="index" collection="productLineIds"
					 open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>

		<if test="equipmentIds != null">
			AND t.equipment_id IN
			<foreach item="item" index="index" collection="equipmentIds"
					 open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>

		<if test="equipmentId != null and equipmentId != ''">
			AND t.equipment_id = #{equipmentId}
		</if>
		<if test="productLineId != null and productLineId != ''">
			AND f.product_line_id = #{productLineId}
		</if>
		<if test="startDate != null">
			AND t.create_time <![CDATA[>=]]> #{startDate}
		</if>
		<if test="endDate != null">
			AND t.create_time <![CDATA[<=]]>#{endDate}
		</if>
		<if test="alarmStatus != null and alarmStatus != ''">
			AND t.alarm_status = #{alarmStatus}
		</if>

		group by t.id

		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>

	<select id="countAlarmRecords" parameterType="com.kuyun.eam.vo.EamAlarmRecordVO" resultType="java.lang.Long">
		select
		count(DISTINCT t.id)
		from eam_alarm_record t
		LEFT JOIN eam_alarm a ON t.alarm_id = a.alarm_id
		LEFT JOIN eam_alarm_target_user u ON t.alarm_id = u.alarm_id
		LEFT JOIN upms_user uu ON uu.user_id = u.user_id
		LEFT JOIN eam_equipment e ON e.equipment_id = t.equipment_id
		LEFT JOIN eam_product_line f ON f.product_line_id = t.product_line_id
		WHERE t.delete_flag = 0 AND a.delete_flag = 0 AND f.delete_flag = 0
		AND e.delete_flag = 0
		<if test="productLineIds != null">
			AND t.product_line_id IN
			<foreach item="item" index="index" collection="productLineIds"
					 open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>

		<if test="equipmentIds != null">
			AND t.equipment_id IN
			<foreach item="item" index="index" collection="equipmentIds"
					 open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>

		<if test="equipmentId != null and equipmentId != ''">
			AND t.equipment_id = #{equipmentId}
		</if>
		<if test="productLineId != null and productLineId != ''">
			AND f.product_line_id = #{productLineId}
		</if>
		<if test="startDate != null">
			AND t.create_time <![CDATA[>=]]> #{startDate}
		</if>
		<if test="endDate != null">
			AND t.create_time <![CDATA[<=]]>#{endDate}
		</if>
		<if test="alarmStatus != null and alarmStatus != ''">
			AND t.alarm_status = #{alarmStatus}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
	</select>

	<sql id="Alarm_Record_History_Column_List">
		t.id, t.alarm_id, t.equipment_id, t.product_line_id,  t.alarm_value, t.alarm_status,
		t.alarm_clear_value, t.create_user_id, t.create_time, t.update_user_id, t.update_time, t.delete_flag,
		t.company_id,
	</sql>

	<select id="selectAlarmRecordHistoies" parameterType="com.kuyun.eam.vo.EamAlarmRecordVO" resultMap="EamAlarmRecordVOResultMap">
		select DISTINCT
		<include refid="Alarm_Record_History_Column_List" />
		a.name as alarm_name,
		a.alarm_type,
		a.upper_Bound,
		a.lower_Bound,
		a.duration,
		a.alarm_target,
		group_concat(uu.realname) AS user_name,
		e.name as equipment_name,
		e.number as equipment_number,
		f.name as product_line_name
		from eam_alarm_record_history t
		LEFT JOIN eam_alarm a ON t.alarm_id = a.alarm_id
		LEFT JOIN eam_alarm_target_user u ON t.alarm_id = u.alarm_id
		LEFT JOIN upms_user uu ON uu.user_id = u.user_id AND u.delete_flag = 0
		LEFT JOIN eam_equipment e ON e.equipment_id = t.equipment_id
		LEFT JOIN eam_product_line f ON f.product_line_id = t.product_line_id
		WHERE t.delete_flag = 0 AND a.delete_flag = 0 AND f.delete_flag = 0
		AND e.delete_flag = 0

		<if test="productLineIds != null">
			AND t.product_line_id IN
			<foreach item="item" index="index" collection="productLineIds"
					 open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>

		<if test="equipmentIds != null">
			AND t.equipment_id IN
			<foreach item="item" index="index" collection="equipmentIds"
					 open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>

		<if test="equipmentId != null and equipmentId != ''">
			AND t.equipment_id = #{equipmentId}
		</if>
		<if test="productLineId != null and productLineId != ''">
			AND f.product_line_id = #{productLineId}
		</if>
		<if test="startDate != null">
			AND t.create_time <![CDATA[>=]]> #{startDate}
		</if>
		<if test="endDate != null">
			AND t.create_time <![CDATA[<=]]>#{endDate}
		</if>
		<if test="alarmStatus != null and alarmStatus != ''">
			AND t.alarm_status = #{alarmStatus}
		</if>

		group by t.id

		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>

	<select id="countAlarmRecordHistoies" parameterType="com.kuyun.eam.vo.EamAlarmRecordVO" resultType="java.lang.Long">
		select
		count(DISTINCT t.id)
		from eam_alarm_record_history t
		LEFT JOIN eam_alarm a ON t.alarm_id = a.alarm_id
		LEFT JOIN eam_alarm_target_user u ON t.alarm_id = u.alarm_id
		LEFT JOIN upms_user uu ON uu.user_id = u.user_id
		LEFT JOIN eam_equipment e ON e.equipment_id = t.equipment_id
		LEFT JOIN eam_product_line f ON f.product_line_id = t.product_line_id
		WHERE t.delete_flag = 0 AND a.delete_flag = 0 AND f.delete_flag = 0
		AND e.delete_flag = 0
		<if test="productLineIds != null">
			AND t.product_line_id IN
			<foreach item="item" index="index" collection="productLineIds"
					 open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>

		<if test="equipmentIds != null">
			AND t.equipment_id IN
			<foreach item="item" index="index" collection="equipmentIds"
					 open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>

		<if test="equipmentId != null and equipmentId != ''">
			AND t.equipment_id = #{equipmentId}
		</if>
		<if test="productLineId != null and productLineId != ''">
			AND f.product_line_id = #{productLineId}
		</if>
		<if test="startDate != null">
			AND t.create_time <![CDATA[>=]]> #{startDate}
		</if>
		<if test="endDate != null">
			AND t.create_time <![CDATA[<=]]>#{endDate}
		</if>
		<if test="alarmStatus != null and alarmStatus != ''">
			AND t.alarm_status = #{alarmStatus}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>

	</select>


	<resultMap id="EamEquipmentVOResultMap" type="com.kuyun.eam.vo.EamEquipmentVO" extends="com.kuyun.eam.dao.mapper.EamEquipmentMapper.BaseResultMap">
	</resultMap>

	<select id="selectEquipments" parameterType="com.kuyun.eam.vo.EamEquipmentVO" resultMap="EamEquipmentVOResultMap">
		select
		<include refid="com.kuyun.eam.dao.mapper.EamEquipmentMapper.Base_Column_List" />
		from eam_equipment
		WHERE delete_flag = 0
		<if test="productLineId != null and productLineId != ''">
			AND product_line_id = #{productLineId}
		</if>
		<if test="equipmentCategoryId != null and equipmentCategoryId != ''">
			AND equipment_category_id = #{equipmentCategoryId}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>

	<select id="countEquipments" parameterType="com.kuyun.eam.vo.EamEquipmentVO" resultType="java.lang.Long">
		select count(*)
		from eam_equipment
		WHERE delete_flag = 0
		<if test="productLineId != null and productLineId != ''">
			AND eam_equipment.product_line_id = #{productLineId}
		</if>
		<if test="equipmentCategoryId != null and equipmentCategoryId != ''">
			AND eam_equipment.equipment_category_id = #{equipmentCategoryId}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
	</select>

	<select id="selectUnAuthProductLines" parameterType="com.kuyun.eam.vo.EamProductLineVO" resultMap="EamProductLineVOResultMap">
		select
		<include refid="com.kuyun.eam.dao.mapper.EamProductLineMapper.Base_Column_List" />
		from eam_product_line eam_product_line
		LEFT JOIN eam_product_line_company e ON eam_product_line.product_line_id = e.product_line_id AND e.delete_flag = 0
		WHERE eam_product_line.delete_flag = 0
		<if test="companyId != null and companyId != ''">
			AND (e.company_id = #{companyId}
			     OR eam_product_line.product_line_id not in (
					select product_line_id from eam_product_line_company where company_id != 1
			))
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>

	<select id="countUnAuthProductLines" parameterType="com.kuyun.eam.vo.EamProductLineVO" resultType="java.lang.Long">
		select
		count(eam_product_line.product_line_id)
		from eam_product_line eam_product_line
		LEFT JOIN eam_product_line_company e ON eam_product_line.product_line_id = e.product_line_id AND e.delete_flag = 0
		WHERE eam_product_line.delete_flag = 0
		<if test="companyId != null and companyId != ''">
			AND (e.company_id = #{companyId}
			OR eam_product_line.product_line_id not in (
			select product_line_id from eam_product_line_company where company_id != 1
			))
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
	</select>


	<resultMap id="EamProductLineVOResultMap" type="com.kuyun.eam.vo.EamProductLineVO" extends="com.kuyun.eam.dao.mapper.EamProductLineMapper.BaseResultMap">
		<result column="company_name" jdbcType="VARCHAR" property="companyName" />
		<result column="company_address" jdbcType="VARCHAR" property="companyAddress" />
	</resultMap>

	<select id="selectProductLines" parameterType="com.kuyun.eam.vo.EamProductLineVO" resultMap="EamProductLineVOResultMap">
		select
		(select c.name  from upms_company c where c.company_id = max(e.company_id)) as company_name,
		(select c.address  from upms_company c where c.company_id = max(e.company_id)) as company_address,
		<include refid="com.kuyun.eam.dao.mapper.EamProductLineMapper.Base_Column_List" />
		from eam_product_line eam_product_line
		LEFT JOIN eam_product_line_company e ON eam_product_line.product_line_id = e.product_line_id
		WHERE eam_product_line.delete_flag = 0 AND e.delete_flag = 0
		<if test="companyId != null and companyId != ''">
			AND e.company_id = #{companyId}
		</if>
		group by eam_product_line.product_line_id
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>

	<select id="countProductLines" parameterType="com.kuyun.eam.vo.EamProductLineVO" resultType="java.lang.Long">
		select count(DISTINCT eam_product_line.product_line_id)
		from eam_product_line eam_product_line
		LEFT JOIN eam_product_line_company e ON eam_product_line.product_line_id = e.product_line_id
		WHERE eam_product_line.delete_flag = 0 AND e.delete_flag = 0
		<if test="companyId != null and companyId != ''">
			AND e.company_id = #{companyId}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
	</select>


	<resultMap id="EamDataElementVOResultMap" type="com.kuyun.eam.vo.EamDataElementVO" extends="com.kuyun.eam.dao.mapper.EamDataElementMapper.BaseResultMap">
		<result column="equipment_category_name" jdbcType="VARCHAR" property="equipmentCategoryName" />
	</resultMap>


	<sql id="DataElement_Column_List">
		t.id, t.name, t.lable_name, t.unit, t.data_type, t.equipment_category_id, t.create_user_id, t.create_time,
    	t.update_user_id, t.update_time, t.delete_flag, t.is_statistic_by_date,t.is_statistic_by_shift, t.is_summation,
	</sql>

	<select id="selectDataElements" parameterType="com.kuyun.eam.vo.EamDataElementVO" resultMap="EamDataElementVOResultMap">
		select
		<include refid="DataElement_Column_List" />
		e.name as equipment_category_name
		from eam_data_element t
		LEFT JOIN eam_equipment_category e ON t.equipment_category_id = e.equipment_category_id
		WHERE t.delete_flag = 0
		<if test="equipmentCategoryId != null">
			AND t.equipment_category_id = #{equipmentCategoryId}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>


	<resultMap id="EamAlarmModelVOResultMap" type="com.kuyun.eam.vo.EamAlarmModelVO" extends="com.kuyun.eam.dao.mapper.EamAlarmModelMapper.BaseResultMap">
		<result column="data_element_name" jdbcType="VARCHAR" property="dataElementName" />
	</resultMap>

	<select id="selectAlarmModels" parameterType="com.kuyun.eam.vo.EamAlarmModelVO" resultMap="EamAlarmModelVOResultMap">
		select
		e.lable_name as data_element_name,
		<include refid="com.kuyun.eam.dao.mapper.EamAlarmModelMapper.Base_Column_List" />
		from eam_alarm_model
		LEFT JOIN eam_data_element e ON eam_alarm_model.eam_data_element_id = e.id
		WHERE eam_alarm_model.delete_flag = 0
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>


	<resultMap id="EamEquipmentDataGroupVOResultMap" type="com.kuyun.eam.vo.EamEquipmentDataGroupVO" extends="com.kuyun.eam.dao.mapper.EamEquipmentDataGroupMapper.BaseResultMap">
		<result column="dataGroupName" jdbcType="VARCHAR" property="dataGroupName" />
	</resultMap>

	<select id="selectEquipmentDataGroups" parameterType="com.kuyun.eam.vo.EamEquipmentDataGroupVO" resultMap="EamEquipmentDataGroupVOResultMap">
		select
		e.name AS dataGroupName,
		<include refid="com.kuyun.eam.dao.mapper.EamEquipmentDataGroupMapper.Base_Column_List" />
		from eam_equipment_data_group
		LEFT JOIN eam_data_element_group e ON eam_equipment_data_group.data_group_id = e.id
		WHERE eam_equipment_data_group.delete_flag = 0 AND e.delete_flag = 0
		<if test="equipmentId != null and equipmentId != ''">
			AND equipment_id = #{equipmentId}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>

	<select id="countEquipmentDataGroups" parameterType="com.kuyun.eam.vo.EamEquipmentDataGroupVO" resultType="java.lang.Long">
		select count(*)
		from eam_equipment_data_group
		WHERE delete_flag = 0
		<if test="equipmentId != null and equipmentId != ''">
			AND equipment_id = #{equipmentId}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
	</select>


	<resultMap id="EamAlarmVOResultMap" type="com.kuyun.eam.vo.EamAlarmVO" extends="com.kuyun.eam.dao.mapper.EamAlarmMapper.BaseResultMap">
		<result column="target_user_name" jdbcType="VARCHAR" property="targetUserName" />
		<result column="alarm_lable_name" jdbcType="VARCHAR" property="alarmLableName" />
	</resultMap>

	<select id="selectAlarms" parameterType="com.kuyun.eam.vo.EamAlarmVO" resultMap="EamAlarmVOResultMap">
		select
		group_concat(u.realname) AS target_user_name,
		d.lable_name as alarm_lable_name,
		<include refid="com.kuyun.eam.dao.mapper.EamAlarmMapper.Base_Column_List" />
		from eam_alarm
		LEFT JOIN eam_alarm_target_user e ON eam_alarm.alarm_id = e.alarm_id AND e.delete_flag = 0
		LEFT JOIN eam_data_element d ON eam_alarm.eam_data_element_id = d.id
		LEFT JOIN upms_user u ON e.user_id = u.user_id
		WHERE eam_alarm.delete_flag = 0
		<if test="productLineId != null and productLineId != ''">
			AND eam_alarm.product_line_id = #{productLineId}
		</if>
		<if test="equipmentId != null and equipmentId != ''">
			AND eam_alarm.equipment_id = #{equipmentId}
		</if>

		group by eam_alarm.alarm_id

		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>

	</select>

	<select id="countAlarms" parameterType="com.kuyun.eam.vo.EamAlarmVO" resultType="java.lang.Long">
		select count(*)
		from eam_alarm
		WHERE delete_flag = 0
		<if test="productLineId != null and productLineId != ''">
			AND product_line_id = #{productLineId}
		</if>
		<if test="equipmentId != null and equipmentId != ''">
			AND equipment_id = #{equipmentId}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
	</select>

	<resultMap id="EamGrmVariableDataVOResultMap" type="com.kuyun.eam.vo.EamGrmVariableDataExtVO">
		<result column="data_element_name" jdbcType="VARCHAR" property="dataElementName" />
		<result column="data_element_id" jdbcType="VARCHAR" property="dataElementId" />
		<result column="value" jdbcType="VARCHAR" property="value" />
		<result column="unit" jdbcType="VARCHAR" property="unit" />
		<result column="data_type" jdbcType="VARCHAR" property="dataType" />
		<result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
		<result column="grm_period" jdbcType="INTEGER" property="grmPeriod" />
	</resultMap>

	<select id="selectEamGrmVariableData" parameterType="com.kuyun.eam.vo.EamGrmVariableDataVO" resultMap="EamGrmVariableDataVOResultMap">
		select
		DISTINCT
		e.unit,
		e.lable_name as data_element_name,
		egvd.value,
		egvd.update_time,
		egvd.data_element_id,
		e.data_type,
		case when egv.grm_period is null then p.grm_period else egv.grm_period END grm_period
		from eam_grm_variable_data egvd,
		eam_data_element e,
		eam_grm_variable egv,
		eam_product_line p,
		eam_grm_variable_group egvg
		WHERE egvd.delete_flag = 0
		AND e.delete_flag = 0
		AND egv.delete_flag = 0
		AND p.delete_flag = 0
		AND egvg.delete_flag = 0
		AND egvd.data_element_id = e.id
		AND egvd.eam_grm_variable_id = egv.id
		AND egvd.product_line_id = p.product_line_id
		AND egv.id = egvg.eam_grm_variable_id
		<if test="productLineId != null and productLineId != ''">
			AND egvd.product_line_id = #{productLineId}
		</if>

		<if test="equipmentIdIsNull != null">
			AND egvd.equipment_id is null
		</if>

		<if test="equipmentId != null and equipmentId != ''">
			AND egvd.equipment_id = #{equipmentId}
		</if>

		<if test="dataGroupId != null and dataGroupId != ''">
			AND egvg.data_group_id = #{dataGroupId}
		</if>

		<if test="equipmentDataGroupId != null and equipmentDataGroupId != ''">
			AND egvg.equipment_data_group_id = #{equipmentDataGroupId}
		</if>

		<if test="dataElementId != null and dataElementId != ''">
			AND egvd.data_element_id = #{dataElementId}
		</if>

		<if test="startDate != null">
			AND egvd.update_time <![CDATA[>=]]> #{startDate}
		</if>
		<if test="endDate != null">
			AND egvd.update_time <![CDATA[<=]]>#{endDate}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>

	<resultMap id="EamGrmVariableGroupVOResultMap" type="com.kuyun.eam.vo.EamGrmVariableGroupVO" extends="com.kuyun.eam.dao.mapper.EamGrmVariableGroupMapper.BaseResultMap">
	</resultMap>

	<select id="selectEamGrmVariableGroup" parameterType="com.kuyun.eam.vo.EamGrmVariableGroupVO" resultMap="EamGrmVariableGroupVOResultMap">
		select
		<include refid="com.kuyun.eam.dao.mapper.EamGrmVariableGroupMapper.Base_Column_List" />
		from eam_grm_variable_group,
		eam_grm_variable egv
		WHERE eam_grm_variable_group.delete_flag = 0
		AND egv.delete_flag = 0
		AND egv.id = eam_grm_variable_group.eam_grm_variable_id
		<if test="productLineId != null and productLineId != ''">
			AND egv.product_line_id = #{productLineId}
		</if>
		<if test="equipmentId != null and equipmentId != ''">
			AND egv.equipment_id = #{equipmentId}
		</if>

		<if test="dataGroupId != null and dataGroupId != ''">
			AND eam_grm_variable_group.data_group_id = #{dataGroupId}
		</if>
		<if test="equipmentDataGroupId != null and equipmentDataGroupId != ''">
			AND eam_grm_variable_group.equipment_data_group_id = #{equipmentDataGroupId}
		</if>
	</select>

	<select id="selectUsedEamGrmVariable" parameterType="com.kuyun.eam.vo.EamGrmVariableVO" resultMap="EamGrmVariableVOResultMap">
		select
		count(eam_grm_variable.id) count_id,
		eam_grm_variable.id,
		eam_grm_variable.name
		from eam_grm_variable,
		eam_grm_variable_group egvg
		WHERE eam_grm_variable.delete_flag = 0
		AND eam_grm_variable.id = egvg.eam_grm_variable_id
		AND egvg.delete_flag = 0

		<if test="productLineId != null and productLineId != ''">
			AND eam_grm_variable.product_line_id = #{productLineId}
		</if>
		<if test="equipmentId != null and equipmentId != ''">
			AND eam_grm_variable.equipment_id = #{equipmentId}
		</if>
		<if test="dataGroupId != null and dataGroupId != ''">
			AND egvg.data_group_id = #{dataGroupId}
		</if>
		<if test="equipmentDataGroupId != null and equipmentDataGroupId != ''">
			AND egvg.equipment_data_group_id = #{equipmentDataGroupId}
		</if>
		GROUP BY eam_grm_variable.name, eam_grm_variable.id
		HAVING count_id = 1;
	</select>

	<resultMap id="EamGrmVariableDataHistoryVOResultMap" type="com.kuyun.eam.vo.EamGrmVariableDataHistoryExtVO" >
		<result column="data_element_name" jdbcType="VARCHAR" property="dataElementName" />
		<result column="lable_name" jdbcType="VARCHAR" property="lableName" />
		<result column="data_element_id" jdbcType="INTEGER" property="dataElementId" />
		<result column="value" jdbcType="VARCHAR" property="value" />
		<result column="unit" jdbcType="VARCHAR" property="unit" />
		<result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
	</resultMap>

	<select id="selectEamGrmVariableDataHistories" parameterType="com.kuyun.eam.vo.EamGrmVariableDataHistoryVO" resultMap="EamGrmVariableDataHistoryVOResultMap">
		select
		DISTINCT
		e.unit,
		e.lable_name,
		egvdh.data_element_id,
		egvdh.value,
		egvdh.update_time
		from eam_grm_variable_data_history egvdh,
		eam_data_element e,
		eam_grm_variable egv,
		eam_grm_variable_group egvg
		WHERE egvdh.delete_flag = 0
		AND e.delete_flag = 0
		AND egv.delete_flag = 0
		AND egvg.delete_flag = 0
		AND egvdh.data_element_id = e.id
		AND egvdh.eam_grm_variable_id = egv.id
		AND egv.id = egvg.eam_grm_variable_id

		<if test="productLineId != null and productLineId != ''">
			AND egvdh.product_line_id = #{productLineId}
		</if>

		<if test="equipmentIdIsNull != null">
			AND egvdh.equipment_id IS NULL
		</if>

		<if test="equipmentId != null and equipmentId != ''">
			AND egvdh.equipment_id = #{equipmentId}
		</if>

		<if test="dataGroupId != null and dataGroupId != ''">
			AND egvg.data_group_id = #{dataGroupId}
		</if>

		<if test="equipmentDataGroupId != null and equipmentDataGroupId != ''">
			AND egvg.equipment_data_group_id = #{equipmentDataGroupId}
		</if>

		<if test="dataElementId != null and dataElementId != ''">
			AND egvdh.data_element_id = #{dataElementId}
		</if>

		<if test="dataElementIds != null">
			AND egvdh.data_element_id IN
			<foreach item="item" index="index" collection="dataElementIds"
					 open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>

		<if test="startDate != null">
			<choose>
				<when test="startDate != null and interval != null and grmPeriod != null">
					AND egvdh.update_time <![CDATA[>=]]> #{startDate}

					AND (time_to_sec(timediff(egvdh.update_time, #{startDate})) mod #{interval} <![CDATA[<]]> #{grmPeriod})
				</when>
				<otherwise>
					AND egvdh.update_time <![CDATA[>=]]> #{startDate}
				</otherwise>
			</choose>
		</if>

		<if test="endDate != null">
			AND egvdh.update_time <![CDATA[<=]]>#{endDate}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>

	<resultMap id="EamTicketAssessmentTagVOResultMap" type="com.kuyun.eam.vo.EamTicketAssessmentTagVO" extends="com.kuyun.eam.dao.mapper.EamTicketMapper.BaseResultMap">
		<result column="tag_name" jdbcType="VARCHAR" property="tagName" />
	</resultMap>

	<select id="selectTicketAssessmentTags" parameterType="com.kuyun.eam.vo.EamTicketAssessmentTagVO" resultMap="EamTicketAssessmentTagVOResultMap">
		select
		e.name as tag_name
		from eam_ticket_assessment_tag t,eam_ticket_tag e
		WHERE e.delete_flag = 0 and t.tag_id = e.id
		<if test="assessmentId != null and assessmentId != ''">
			AND t.assessment_id = #{assessmentId}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>


	<resultMap id="EamTicketAppointVOResultMap" type="com.kuyun.eam.vo.EamTicketAppointVO" extends="com.kuyun.eam.dao.mapper.EamTicketAppointedRecordMapper.BaseResultMap">
		<result column="username" jdbcType="VARCHAR" property="userName" />
		<result column="phone" jdbcType="VARCHAR" property="phone" />
	</resultMap>

	<select id="selectTicketAppointRecord" parameterType="com.kuyun.eam.dao.model.EamTicketAppointedRecordExample" resultMap="EamTicketAppointVOResultMap">
		select
		<include refid="com.kuyun.eam.dao.mapper.EamTicketAppointedRecordMapper.Base_Column_List" /> ,
		uu.realname as username,
		uu.phone
		from eam_ticket_appointed_record
		LEFT OUTER JOIN upms_user uu ON order_taker_id = uu.user_id
		<if test="_parameter != null">
			<include refid="com.kuyun.eam.dao.mapper.EamTicketAppointedRecordMapper.Example_Where_Clause" />
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>

	<resultMap id="SummaryTicketVOResultMap" type="com.kuyun.eam.vo.EamSummaryTicketVO" >
		<result column="status" jdbcType="VARCHAR" property="statusName" />
		<result column="count" jdbcType="INTEGER" property="count" />
	</resultMap>

	<select id="summaryTicket" parameterType="Integer" resultMap="SummaryTicketVOResultMap">
		select status, count(ticket_id) as count from eam_ticket
		where delete_flag=0 and company_id=#{companyId, jdbcType=INTEGER} group by status
	</select>

	<resultMap id="EamMaintainPlanVOResultMap" type="com.kuyun.eam.vo.EamMaintainPlanVO" extends="com.kuyun.eam.dao.mapper.EamMaintainPlanMapper.BaseResultMap">
		<result column="equipmentCategoryName" jdbcType="VARCHAR" property="equipmentCategoryName" />
		<result column="equipmentName" jdbcType="VARCHAR" property="equipmentName" />
		<result column="productLineName" jdbcType="VARCHAR" property="productLineName" />
		<result column="maintainUsers" jdbcType="VARCHAR" property="maintainUsers" />
	</resultMap>

	<select id="listMaintainPlans" parameterType="com.kuyun.eam.vo.EamMaintainPlanVO" resultMap="EamMaintainPlanVOResultMap">
		select DISTINCT
		a.plan_id, work_content, next_maintain_date, maintain_frequency_unit,
		maintain_frequency_quantity, maintain_type, remind_time, a.create_time,
		a.equipment_id,
		a.product_line_id,
		group_concat(uu.realname) AS maintainUsers,
		ec.name as equipmentCategoryName,
		e.name as equipmentName,
		p.name as productLineName
		from eam_maintain_plan a
		LEFT OUTER JOIN eam_equipment_category ec ON a.equipment_category_id = ec.equipment_category_id
		LEFT OUTER JOIN eam_equipment e ON a.equipment_id = e.equipment_id
		LEFT OUTER JOIN eam_product_line p ON a.product_line_id = p.product_line_id
		LEFT OUTER JOIN eam_maintain_user mu ON (a.plan_id = mu.plan_id AND mu.delete_flag = 0)
		LEFT OUTER JOIN upms_user uu ON mu.user_id = uu.user_id
		WHERE a.delete_flag = 0
		<if test="companyId != null and companyId != ''">
			AND a.company_id = #{companyId}
		</if>
		group by a.plan_id
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>

	<select id="countMaintainPlans" parameterType="com.kuyun.eam.vo.EamMaintainPlanVO" resultType="java.lang.Long">
		select
		count(DISTINCT a.plan_id)
		from eam_maintain_plan a
		LEFT OUTER JOIN eam_equipment_category ec ON a.equipment_category_id = ec.equipment_category_id
		LEFT OUTER JOIN eam_equipment e ON a.equipment_id = e.equipment_id
		LEFT OUTER JOIN eam_product_line p ON a.product_line_id = p.product_line_id
		WHERE a.delete_flag = 0
		<if test="companyId != null and companyId != ''">
			AND a.company_id = #{companyId}
		</if>
	</select>

	<select id="getMaintainPlan" parameterType="Integer" resultMap="EamMaintainPlanVOResultMap">
		select
        a.plan_id, work_content, next_maintain_date, maintain_frequency_unit, maintain_frequency_quantity, maintain_type, remind_time, a.create_time ,
        ec.name as equipmentCategoryName,
        e.name as equipmentName,
        p.name as productLineName,
        group_concat(uu.realname) AS maintainUsers
        from eam_maintain_plan a
        LEFT OUTER JOIN eam_equipment_category ec ON a.equipment_category_id = ec.equipment_category_id
        LEFT OUTER JOIN eam_equipment e ON a.equipment_id = e.equipment_id
        LEFT OUTER JOIN eam_product_line p ON a.product_line_id = p.product_line_id
        LEFT OUTER JOIN eam_maintain_user mu ON a.plan_id = mu.plan_id
		LEFT OUTER JOIN upms_user uu ON mu.user_id = uu.user_id
		WHERE a.delete_flag = 0 and mu.delete_flag = 0 and a.plan_id=#{planId, jdbcType=INTEGER}
		group by a.plan_id
	</select>

	<resultMap id="EamPlanTicketVOResultMap" type="com.kuyun.eam.vo.EamPlanTicketVO" extends="com.kuyun.eam.dao.mapper.EamTicketMapper.BaseResultMap">
		<result column="serviceman" jdbcType="VARCHAR" property="serviceman" />
		<result column="servicePhone" jdbcType="VARCHAR" property="servicePhone" />
		<result column="customerContacts" jdbcType="VARCHAR" property="customerContacts" />
		<result column="customerPhone" jdbcType="VARCHAR" property="customerPhone" />
		<result column="assessmentDescription" jdbcType="VARCHAR" property="assessmentDescription" />
		<result column="assessment_level" jdbcType="INTEGER" property="assessmentLevel" />
		<result column="assessmentId" jdbcType="INTEGER" property="assessmentId" />
		<result column="planId" jdbcType="INTEGER" property="planId" />
		<result column="planTicketId" jdbcType="INTEGER" property="planTicketId" />
		<result column="ticketTypeName" jdbcType="VARCHAR" property="ticketTypeName" />
	</resultMap>

	<select id="selectTicketByPlan" parameterType="com.kuyun.eam.vo.EamPlanTicketVO" resultMap="EamPlanTicketVOResultMap">
		SELECT t.description as ticketDescription,   t.priority as ticketPriority,
		t.status as ticketStatus,   uu.realname as serviceman,
		uu.phone as servicePhone,   cu.realname as customerContacts,   cu.phone as customerPhone,
		ass.assessment_level,
		ass.description as assessmentDescription,   ass.id as assessmentId,   mt.plan_id as planId,
		mt.id as planTicketId,
		eam_ticket_type.name as ticketTypeName
		from eam_maintain_ticket mt
		LEFT JOIN eam_ticket t on t.ticket_id = mt.ticket_id
		LEFT OUTER JOIN eam_ticket_type  ON t.ticket_type_id = eam_ticket_type.id
		LEFT OUTER JOIN upms_user uu ON t.executor_id = uu.user_id
		LEFT OUTER JOIN upms_user cu ON t.create_user_id = cu.user_id
		LEFT OUTER JOIN eam_ticket_assessment ass ON t.ticket_id = ass.ticket_id
		where t.delete_flag = 0 and mt.delete_flag = 0
		<if test="planId != null and planId != ''">
			AND mt.plan_id = #{planId}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>

	<resultMap id="TicketRejectRecordVOResultMap" type="com.kuyun.eam.vo.EamTicketRejectRecordVO" >
		<result column="reject_commont" jdbcType="VARCHAR" property="rejectCommont" />
		<result column="realname" jdbcType="VARCHAR" property="userName" />
		<result column="create_time" jdbcType="VARCHAR" property="rejectDate" />
	</resultMap>

	<select id="getTicketRejectRecord" parameterType="Integer" resultMap="TicketRejectRecordVOResultMap">
		select u.username, u.realname, ar.reject_commont, ar.create_time from eam_ticket_appointed_record ar, upms_user u
		where ar.order_taker_id = u.user_id and ar.ticket_id =#{ticketId, jdbcType=INTEGER} order by ar.create_time desc
	</select>


	<resultMap id="CodeValueVOResultMap" type="com.kuyun.eam.vo.EamCodeValueVo" >
	</resultMap>

	<select id="summaryIndustry" resultMap="CodeValueVOResultMap">
		select count(c.id) as value, v.code_name as name
		from eam_order c, eam_code_value v
		where c.industry = v.code_value
		and v.category = 'INDUSTRY'
		and c.delete_flag = 0 and v.delete_flag = 0
		group by v.code_name
		ORDER by value
	</select>

	<select id="summaryProductLineType" resultMap="CodeValueVOResultMap">
		select count(c.id) as value, v.code_name as name
		from eam_order c, eam_code_value v
		where c.product_line_type = v.code_value
		and v.category = 'PRODUCT_LINE_TYPE'
		and c.delete_flag = 0 and v.delete_flag = 0
		group by v.code_name
		ORDER by value
	</select>

	<select id="summaryState" resultMap="CodeValueVOResultMap">
		select count(c.id) as value, v.code_name as name
		from eam_order c, eam_code_value v
		where c.state = v.code_value
		and v.category = 'STATE'
		and c.delete_flag = 0 and v.delete_flag = 0
		group by v.code_name
		ORDER by value
	</select>

	<resultMap id="CountryValueVOResultMap" type="com.kuyun.eam.vo.EamCountryValueVo" >
	</resultMap>

	<select id="summaryCountry" resultMap="CountryValueVOResultMap">
		select sum(value) as value, year, country
		from (
			select count(id) as value, year,
			CASE
				WHEN TRIM(country) = '中国' THEN '国内'
				ELSE '国外'
			END AS COUNTRY
			from eam_order
			where delete_flag = 0
			group by year, COUNTRY
			ORDER BY year, country
        ) T
        group by year, country
	</select>

	<resultMap id="IndustryValueVOResultMap" type="com.kuyun.eam.vo.EamIndustryValueVo" >
	</resultMap>

	<select id="summaryIndustryAndCompanyName" resultMap="IndustryValueVOResultMap">
		select industry,
		IFNULL(short_name, company_name) companyName,
		count(id) as count from eam_order
		where delete_flag = 0
		group by industry, companyName
		order by count desc, industry, companyName asc
	</select>

	<resultMap id="eamGrmVariableDataVO" type="com.kuyun.eam.vo.EamGrmVariableDataVO" extends="com.kuyun.eam.dao.mapper.EamGrmVariableMapper.BaseResultMap">
		<result column="data_type" jdbcType="VARCHAR" property="dataType" />
		<result column="is_summation" jdbcType="INTEGER" property="isSummation" />
	</resultMap>
	<select id="selectStatisticGrmVariable" resultMap="eamGrmVariableDataVO">
		select
		eam_grm_variable.id as eam_grm_variable_id,
		eam_grm_variable.equipment_id as eam_grm_variable_equipment_id,
		eam_grm_variable.product_line_id as eam_grm_variable_product_line_id,
		eam_grm_variable.data_element_id as eam_grm_variable_data_element_id,
		e.data_type, e.is_summation
		from eam_grm_variable, eam_data_element e
		where eam_grm_variable.delete_flag = 0 and e.delete_flag = 0
		and eam_grm_variable.data_element_id = e.id
		and e.is_statistic_by_date = 1
		ORDER by data_element_id,e.data_type

	</select>

	<resultMap id="EamOrderVOResultMap" type="com.kuyun.eam.vo.EamOrderVO" extends="com.kuyun.eam.dao.mapper.EamOrderMapper.BaseResultMap">
		<result column="stateName" jdbcType="VARCHAR" property="stateName" />
		<result column="industryName" jdbcType="VARCHAR" property="industryName" />
		<result column="productLineTypeName" jdbcType="VARCHAR" property="productLineTypeName" />
		<result column="productLineCapacityName" jdbcType="VARCHAR" property="productLineCapacityName" />
		<result column="packagingMaterialName" jdbcType="VARCHAR" property="packagingMaterialName" />
		<result column="productSpecName" jdbcType="VARCHAR" property="productSpecName" />
	</resultMap>


	<select id="selectOrders" parameterType="com.kuyun.eam.vo.EamOrderVO" resultMap="EamOrderVOResultMap">
		select
		<include refid="com.kuyun.eam.dao.mapper.EamOrderMapper.Base_Column_List" /> ,
		(select code_name from eam_code_value where state = code_value and category = 'STATE') as stateName,
		(select code_name from eam_code_value where industry = code_value and category = 'INDUSTRY') as industryName,
		(select code_name from eam_code_value where product_line_type = code_value and category = 'PRODUCT_LINE_TYPE') as productLineTypeName,
		(select code_name from eam_code_value where product_line_capacity = code_value and category = 'PRODUCT_LINE_CAPACITY') as productLineCapacityName,
		(select code_name from eam_code_value where packaging_material = code_value and category = 'PACKAGING_MATERIAL') as packagingMaterialName,
		(select code_name from eam_code_value where product_spec = code_value and category = 'PRODUCT_SPEC') as productSpecName
		from eam_order
		WHERE delete_flag = 0
		<if test="search != null and search != ''">
			<bind name="pattern" value="'%' + search + '%'" />
			AND company_name like #{pattern}
		</if>

		<if test="industry != null and industry != ''">
			AND industry = #{industry}
		</if>
		<if test="productLineType != null and productLineType != ''">
			AND product_line_type = #{productLineType}
		</if>
		<if test="year != null and year != ''">
			AND year = #{year}
		</if>
		<if test="country != null and country != ''">
			AND country = #{country}
		</if>
		<if test="province != null and province != ''">
			AND province = #{province}
		</if>
		<if test="city != null and city != ''">
			AND city = #{city}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>

	<select id="countOrders" parameterType="com.kuyun.eam.vo.EamOrderVO" resultType="java.lang.Long">
		select count(id)
		from eam_order
		WHERE delete_flag = 0
		<if test="search != null and search != ''">
			<bind name="pattern" value="'%' + search + '%'" />
			AND company_name like #{pattern}
		</if>

		<if test="industry != null and industry != ''">
			AND industry = #{industry}
		</if>
		<if test="productLineType != null and productLineType != ''">
			AND product_line_type = #{productLineType}
		</if>
		<if test="year != null and year != ''">
			AND year = #{year}
		</if>
		<if test="country != null and country != ''">
			AND country = #{country}
		</if>
		<if test="province != null and province != ''">
			AND province = #{province}
		</if>
		<if test="city != null and city != ''">
			AND city = #{city}
		</if>
	</select>

	<resultMap id="EamAlertMessageVOResultMap" type="com.kuyun.eam.vo.EamAlertMessageVO" extends="com.kuyun.eam.dao.mapper.EamAlertMessageMapper.BaseResultMap">
		<result column="product_line_name" jdbcType="VARCHAR" property="productLineName" />
		<result column="equipment_name" jdbcType="VARCHAR" property="equipmentName" />
		<result column="work_content" jdbcType="VARCHAR" property="workContent" />
		<result column="next_maintain_date" jdbcType="VARCHAR" property="nextMaintainDate" />
		<result column="realname" jdbcType="VARCHAR" property="realname" />
	</resultMap>

	<select id="selectEamAlertMessages" parameterType="com.kuyun.eam.vo.EamAlertMessageVO" resultMap="EamAlertMessageVOResultMap">
		select
		<include refid="com.kuyun.eam.dao.mapper.EamAlertMessageMapper.Base_Column_List" />,
		l.name as product_line_name,
		e.name as equipment_name,
		p.work_content,
		p.next_maintain_date,
		u.realname
		from eam_alert_message
		left join eam_maintain_plan p on eam_alert_message.plan_id = p.plan_id
		left join eam_product_line l on p.product_line_id = l.product_line_id
		left join eam_equipment e on p.equipment_id = e.equipment_id
		left join upms_user u on eam_alert_message.user_id= u.user_id
		WHERE eam_alert_message.delete_flag = 0 and p.delete_flag = 0
		and l.delete_flag = 0 and e.delete_flag = 0 and u.delete_flag = 0
		<if test="productLineIds != null">
			AND l.product_line_id IN
			<foreach item="item" index="index" collection="productLineIds"
					 open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="userId != null">
			AND eam_alert_message.user_id = #{userId}
		</if>
		<if test="startDate != null">
			AND eam_alert_message.alert_start_date <![CDATA[>=]]> #{startDate}
		</if>
		<if test="endDate != null">
			AND eam_alert_message.alert_start_date <![CDATA[<=]]>#{endDate}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>
	</select>

	<select id="countEamAlertMessages" parameterType="com.kuyun.eam.vo.EamAlertMessageVO" resultType="java.lang.Long">
		select
		count(eam_alert_message.id)
		from eam_alert_message
		left join eam_maintain_plan p on eam_alert_message.plan_id = p.plan_id
		left join eam_product_line l on p.product_line_id = l.product_line_id
		left join eam_equipment e on p.equipment_id = e.equipment_id
		left join upms_user u on eam_alert_message.user_id= u.user_id
		WHERE eam_alert_message.delete_flag = 0 and p.delete_flag = 0
		and l.delete_flag = 0 and e.delete_flag = 0 and u.delete_flag = 0
		<if test="productLineIds != null">
			AND l.product_line_id IN
			<foreach item="item" index="index" collection="productLineIds"
					 open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		<if test="userId != null">
			AND eam_alert_message.user_id = #{userId}
		</if>
		<if test="startDate != null">
			AND eam_alert_message.alert_start_date <![CDATA[>=]]> #{startDate}
		</if>
		<if test="endDate != null">
			AND eam_alert_message.alert_start_date <![CDATA[<=]]>#{endDate}
		</if>
	</select>

	<select id="sumBottleQuantity"  resultType="java.lang.Long">
		select sum(value * 1)
		from eam_grm_variable_data
		where data_element_id
		in (
			select bottle_quantity_id from eam_product_line
			where delete_flag = 0 and bottle_quantity_id is null
		)
	</select>

	<select id="selectGrmVariableGroupByPeriod" parameterType="java.lang.String" resultMap="com.kuyun.eam.dao.mapper.EamGrmVariableMapper.BaseResultMap">
		select
		max(eam_grm_variable.id) as eam_grm_variable_id,
		eam_grm_variable.grm_period as eam_grm_variable_grm_period
		from eam_grm_variable where delete_flag = 0
		and product_line_id = #{productLineId, jdbcType=VARCHAR}
		group by grm_period

	</select>

	<resultMap id="EamGrmVariableVOResultMap" type="com.kuyun.eam.vo.EamGrmVariableVO" extends="com.kuyun.eam.dao.mapper.EamGrmVariableMapper.BaseResultMap">
		<result column="product_line_name" jdbcType="VARCHAR" property="productLineName" />
		<result column="equipment_name" jdbcType="VARCHAR" property="equipmentName" />
	</resultMap>

	<select id="selectGrmVariables" parameterType="com.kuyun.eam.vo.EamGrmVariableVO" resultMap="EamGrmVariableVOResultMap">
		select
		p.name as product_line_name,
		(select name from eam_equipment e  where e.equipment_id = eam_grm_variable.equipment_id) as equipment_name,
		<include refid="com.kuyun.eam.dao.mapper.EamGrmVariableMapper.Base_Column_List" />
		from eam_grm_variable
		LEFT JOIN eam_product_line p ON eam_grm_variable.product_line_id = p.product_line_id AND p.delete_flag = 0
		WHERE eam_grm_variable.delete_flag = 0
		<if test="productLineId != null and productLineId != ''">
			AND eam_grm_variable.product_line_id = #{productLineId}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
		<if test="limit != null">
			<if test="offset != null">
				limit ${offset}, ${limit}
			</if>
			<if test="offset == null">
				limit ${limit}
			</if>
		</if>

	</select>



	<select id="countGrmVariables" parameterType="com.kuyun.eam.vo.EamGrmVariableVO" resultType="java.lang.Long">
		select
		count(eam_grm_variable.id)
		from eam_grm_variable
		LEFT JOIN eam_product_line p ON eam_grm_variable.product_line_id = p.product_line_id AND p.delete_flag = 0
		WHERE eam_grm_variable.delete_flag = 0
		<if test="productLineId != null and productLineId != ''">
			AND eam_grm_variable.product_line_id = #{productLineId}
		</if>
		<if test="orderByClause != null">
			order by ${orderByClause}
		</if>
	</select>

	<resultMap id="ShiftStatusResultMap" type="com.kuyun.eam.pojo.ShiftStatus">
		<result column="name" jdbcType="VARCHAR" property="product_line_name" />
		<result column="status" jdbcType="VARCHAR" property="status" />
		<result column="date" jdbcType="TIMESTAMP" property="date" />
	</resultMap>

	<select id="selectShiftStatus" resultMap="ShiftStatusResultMap">
		select
		p.product_line_id,
		p.name as name,
		min(h.update_time) as date,
		'开始生产' as status
		from eam_grm_variable_data_history h, eam_product_line p
		WHERE
	    h.update_time <![CDATA[>=]]> (select
			case when now() between CONCAT(date(now()), ' ' , p.morning_shift_start_time) and  CONCAT(date(now()), ' ' , p.morning_shift_end_time)  =  1 then p.morning_shift_start_time
			when now() between CONCAT(date(now()), ' ' , p.middle_shift_start_time) and  CONCAT(date(now()), ' ' , p.middle_shift_end_time) = 1 then p.middle_shift_start_time
			when now() between CONCAT(date(now()), ' ' , p.night_shift_start_time) and  CONCAT(date(now()), ' ' , p.night_shift_end_time) = 1 then p.night_shift_start_time
			else null end start_time from eam_product_line l where l.delete_flag = 0 and p.product_line_id = l.product_line_id)

		AND h.update_time <![CDATA[<=]]> (select
		    case when now() between CONCAT(date(now()), ' ' , p.morning_shift_start_time) and  CONCAT(date(now()), ' ' , p.morning_shift_end_time)  =  1 then p.morning_shift_end_time
			when now() between CONCAT(date(now()), ' ' , p.middle_shift_start_time) and  CONCAT(date(now()), ' ' , p.middle_shift_end_time) = 1 then p.middle_shift_end_time
			when now() between CONCAT(date(now()), ' ' , p.night_shift_start_time) and  CONCAT(date(now()), ' ' , p.night_shift_end_time) = 1 then p.night_shift_end_time
			else null end end_time from eam_product_line l where l.delete_flag = 0 and p.product_line_id = l.product_line_id)
		AND h.value = 1
		AND h.delete_flag = 0 AND p.delete_flag = 0
		AND p.product_line_id = h.product_line_id
		AND p.start_produce_id = h.data_element_id
		group by p.product_line_id
	</select>

	<resultMap id="eamProductLineGrmDataElementVO" type="com.kuyun.eam.vo.EamProductLineGrmDataElementVO" extends="com.kuyun.eam.dao.mapper.EamGrmVariableMapper.BaseResultMap">
		<result column="morning_shift_start_time" jdbcType="VARCHAR" property="morningShiftStartTime" />
		<result column="morning_shift_end_time" jdbcType="VARCHAR" property="morningShiftEndTime" />
		<result column="middle_shift_start_time" jdbcType="VARCHAR" property="middleShiftStartTime" />
		<result column="middle_shift_end_time" jdbcType="VARCHAR" property="middleShiftEndTime" />
		<result column="night_shift_start_time" jdbcType="VARCHAR" property="nightShiftStartTime" />
		<result column="night_shift_end_time" jdbcType="VARCHAR" property="nightShiftEndTime" />
		<result column="data_type" jdbcType="VARCHAR" property="dataType" />
		<result column="is_statistic_by_date" jdbcType="INTEGER" property="isStatisticByDate" />
		<result column="is_statistic_by_shift" jdbcType="INTEGER" property="isStatisticByShift" />
		<result column="is_summation" jdbcType="INTEGER" property="isSummation" />
	</resultMap>

	<select id="getProductShiftGrmVariable" parameterType="com.kuyun.eam.vo.EamGrmVariableVO" resultMap="eamProductLineGrmDataElementVO">
		select
		l.morning_shift_start_time, l.morning_shift_end_time, l.middle_shift_start_time,l.middle_shift_end_time,
		l.night_shift_start_time, l.night_shift_end_time,e.data_type, e.is_statistic_by_date,e.is_statistic_by_shift,e.is_summation,
		<include refid="com.kuyun.eam.dao.mapper.EamGrmVariableMapper.Base_Column_List" />
		from eam_grm_variable, eam_data_element e, eam_product_line l
		where eam_grm_variable.delete_flag = 0 and e.delete_flag = 0
		and eam_grm_variable.data_element_id = e.id
		and eam_grm_variable.product_line_id = l.product_line_id
        and e.is_statistic_by_shift = 1

		<if test="productLineId != null and productLineId != ''">
			AND eam_grm_variable.product_line_id = #{productLineId}
		</if>
		<if test="equipmentId != null and equipmentId != ''">
			AND eam_grm_variable.equipment_id = #{equipmentId}
		</if>
		<if test="dataElementId != null and dataElementId != ''">
			AND eam_grm_variable.data_element_id = #{dataElementId}
		</if>
		<if test="id != null and id != ''">
			AND eam_grm_variable.id = #{id}
		</if>
        <if test="grmVariableIds != null ">
            AND eam_grm_variable.id IN
            <foreach item="item" index="index" collection="grmVariableIds"
                     open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
	</select>

	<!-- 缓存 -->
	<cache type="org.mybatis.caches.ehcache.LoggingEhcache" />

</mapper>
